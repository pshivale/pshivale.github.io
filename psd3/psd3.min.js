var psd3=psd3||{};psd3.Graph=function(t){var i=this;this.config=t,this.defaults={width:400,height:400,value:"value",inner:"inner",label:function(t){return t.label},tooltip:function(t){return void 0!==i.config.value?t[i.config.value]:t.value},transition:"linear",transitionDuration:1e3,donutRadius:0};for(var n in this.defaults)this.defaults.hasOwnProperty(n)&&(t.hasOwnProperty(n)||(t[n]=this.defaults[n]))};
var psd3=psd3||{};psd3.Pie=function(t){psd3.Graph.call(this,t),this.zoomStack=[];var n="top";void 0!==this.config.heading&&void 0!==this.config.heading.pos&&(n=this.config.heading.pos),"top"==n&&this.setHeading(),this.drawPie(t.data),"bottom"==n&&this.setHeading()},psd3.Pie.prototype=Object.create(psd3.Graph.prototype),psd3.Pie.prototype.constructor=psd3.Pie,psd3.Pie.prototype.setHeading=function(){void 0!==this.config.heading&&d3.select("#"+this.config.containerId).append("div").style("text-align","center").style("width",""+this.config.width+"px").style("padding-top","20px").style("padding-bottom","20px").append("strong").text(this.config.heading.text)},psd3.Pie.prototype.getDepth=function(t){for(var n=t[0],e=1;null!==n&&void 0!==n&&void 0!==n[this.config.inner]&&n[this.config.inner].length>0;)n=n[this.config.inner][0],e++;return e},psd3.Pie.prototype.setDataSet=function(t,n,e,i){if(null===t||void 0===t)return i;if(n===e){for(var o=0;o<t.length;o++)i.push(t[o]);return i}for(var a=0;a<t.length;a++)i=this.setDataSet(t[a][this.config.inner],n,e+1,i);return i},psd3.Pie.prototype.drawPie=function(t){var n=this,e=[],i=d3.scale.category20(),o=n.config.containerId+"_tooltip",a=d3.select("#"+n.config.containerId).append("svg").attr("id",n.config.containerId+"_svg").attr("width",n.config.width).attr("height",n.config.height),r=d3.select("#"+n.config.containerId).append("div").attr("id",o).attr("class","psd3Hidden psd3Tooltip");r.append("p").append("span").attr("id","value").text("100%");var s=d3.layout.pie();s.value(function(t){return t[n.config.value]}),s.sort(null);for(var d=n.config.width/2,c=this.getDepth(t),p=0,l=function(t){n.reDrawPie(t,I)},g=function(t,n){return i(n+p)},h=function(t){d3.select("#"+o).style("left",d3.event.clientX+"px").style("top",d3.event.clientY+"px").select("#value").html(n.config.tooltip(t.data,n.config.label)),d3.select("#"+o).classed("psd3Hidden",!1)},f=function(){d3.select("#"+o).classed("psd3Hidden",!0)},u=function(t){t.arc=x,t.length=I.length,t.parentDs=I},v=function(t){var n={startAngle:0,endAngle:0},e=d3.interpolate(n,t);return function(n){return t.arc(e(n))}},y=c;y>=1;y--){var P=n.config.donutRadius+(d-n.config.donutRadius)/c*y,m=P-d/c;1==y&&(m=n.config.donutRadius);var x=d3.svg.arc().innerRadius(m).outerRadius(P),w="arc"+y,D=[],I=this.setDataSet(t,y,1,D),b=a.selectAll("g."+w).data(s(I)).enter().append("g").attr("class","arc "+w).attr("transform","translate("+d+","+d+")").on("dblclick",l);paths=b.append("path").attr("fill",g),paths.on("mouseover",h),paths.on("mouseout",f),paths.each(u),paths.transition().duration(n.config.transitionDuration).ease(n.config.transition).attrTween("d",v),p+=I.length,e[y]=b}for(var H=function(t){return"translate("+t.arc.centroid(t)+")"},S=function(t){return n.config.label(t.data)},R=function(t){return t.data[n.config.value]},k=1;c>=k;k++)e[k].append("text").transition().ease(n.config.transition).duration(n.config.transitionDuration).delay(n.config.transitionDuration).attr("transform",H).attr("text-anchor","middle").text(S).attr("title",R)},psd3.Pie.prototype.reDrawPie=function(t,n){var e=[];d3.select("#"+this.config.containerId+"_svg").remove(),d3.select("#"+this.config.containerId+"_tooltip").remove(),1==t.length?e=this.zoomStack.pop():(e.push(t.data),this.zoomStack.push(n)),this.drawPie(e)};