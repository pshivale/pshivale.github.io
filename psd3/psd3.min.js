var psd3=psd3||{};psd3.Graph=function(i){this.config=i,this.defaults={width:400,height:400,value:"value",label:function(i){return i.label},tooltip:function(i){return void 0!==this.config.label?this.config.label(i):i.label},transitionDuration:1e3,donutRadius:0}};
var psd3=psd3||{};psd3.Pie=function(t){psd3.Graph.call(this,t),this.zoomStack=new Array;var e="top";void 0!==this.config.heading&&void 0!==this.config.heading.pos&&(e=this.config.heading.pos),"top"==e&&this.setHeading(),this.drawPie(t.data),"bottom"==e&&this.setHeading()},psd3.Pie.prototype=Object.create(psd3.Graph.prototype),psd3.Pie.prototype.constructor=psd3.Pie,psd3.Pie.prototype.setHeading=function(){void 0!==this.config.heading&&d3.select("#"+this.config.containerId).append("div").style("text-align","center").style("width",""+this.config.width+"px").style("padding-top","20px").style("padding-bottom","20px").append("strong").text(this.config.heading.text)},psd3.Pie.prototype.getDepth=function(t){for(var e=t[0],i=0;null!=e||void 0!==e;)e=e.inner[0],i++;return i},psd3.Pie.prototype.setDataSet=function(t,e,i,n){if(null===t||void 0===t)return n;if(e===i){for(var a=0;a<t.length;a++)n.push(t[a]);return n}for(var a=0;a<t.length;a++)n=this.setDataSet(t[a].inner,e,i+1,n);return n},psd3.Pie.prototype.drawPie=function(t){var e,i,n,a,o,r,d,s=this;e=void 0!==config.width?config.width:this.defaults.width,i=void 0!==config.height?config.height:this.defaults.height,n=void 0!==config.transitionDuration?config.transitionDuration:this.defaults.transitionDuration,a=void 0!==config.value?config.value:this.defaults.value,o=void 0!==config.label?config.label:this.defaults.label,r=void 0!==config.tooltip?config.tooltip:this.defaults.tooltip,d=void 0!==config.donutRadius?config.donutRadius:this.defaults.donutRadius;var p=[],c=d3.scale.category20(),l=s.config.containerId+"_tooltip",h=d3.select("#"+s.config.containerId).append("svg").attr("id",s.config.containerId+"_svg").attr("width",e).attr("height",i),u=d3.select("#"+s.config.containerId).append("div").attr("id",l).attr("class","psd3Hidden psd3Tooltip");u.append("p").append("span").attr("id","value").text("100%");var f=d3.layout.pie();f.value(function(t){return t[a]}),f.sort(null);for(var g=e/2,v=this.getDepth(t),y=0,P=v;P>=1;P--){var m=d+(g-d)/v*P,w=m-g/v;1==P&&(w=d);var x=d3.svg.arc().innerRadius(w).outerRadius(m),D="arc"+P,b=[],I=this.setDataSet(t,P,1,b),H=h.selectAll("g."+D).data(f(I)).enter().append("g").attr("class","arc "+D).attr("transform","translate("+g+","+g+")").on("dblclick",function(t){s.reDrawPie(t,I)});paths=H.append("path").attr("fill",function(t,e){return c(e+y)}),paths.on("mouseover",function(t){d3.select("#"+l).style("left",d3.event.clientX+"px").style("top",d3.event.clientY+"px").select("#value").html(r(t.data,o)),d3.select("#"+l).classed("psd3Hidden",!1)}),paths.on("mouseout",function(){d3.select("#"+l).classed("psd3Hidden",!0)}),paths.each(function(t){t.arc=x,t.length=I.length,t.parentDs=I}),paths.transition().duration(n).ease("linear").attrTween("d",function(t){var e={startAngle:0,endAngle:0},i=d3.interpolate(e,t);return function(e){return t.arc(i(e))}}),y+=I.length,p[P]=H}for(var P=1;v>=P;P++)p[P].append("text").transition().ease("linear").duration(n).delay(n).attr("transform",function(t){return"translate("+t.arc.centroid(t)+")"}).attr("text-anchor","middle").text(function(t){return o(t.data)}).attr("title",function(t){return t.data[a]})},psd3.Pie.prototype.reDrawPie=function(t,e){var i=[];d3.select("#"+this.config.containerId+"_svg").remove(),d3.select("#"+this.config.containerId+"_tooltip").remove(),1==t.length?i=this.zoomStack.pop():(i.push(t.data),this.zoomStack.push(e)),this.drawPie(i)};