var psd3=psd3||{};psd3.Graph=function(t){var i=this;this.config=t,this.defaults={width:400,height:400,value:"value",inner:"inner",label:function(t){return t.label},tooltip:function(t){return void 0!==i.config.value?t[i.config.value]:t.value},transitionDuration:1e3,donutRadius:0};for(var n in this.defaults)this.defaults.hasOwnProperty(n)&&(t.hasOwnProperty(n)||(t[n]=this.defaults[n]))};
var psd3=psd3||{};psd3.Pie=function(t){psd3.Graph.call(this,t),this.zoomStack=[];var e="top";void 0!==this.config.heading&&void 0!==this.config.heading.pos&&(e=this.config.heading.pos),"top"==e&&this.setHeading(),this.drawPie(t.data),"bottom"==e&&this.setHeading()},psd3.Pie.prototype=Object.create(psd3.Graph.prototype),psd3.Pie.prototype.constructor=psd3.Pie,psd3.Pie.prototype.setHeading=function(){void 0!==this.config.heading&&d3.select("#"+this.config.containerId).append("div").style("text-align","center").style("width",""+this.config.width+"px").style("padding-top","20px").style("padding-bottom","20px").append("strong").text(this.config.heading.text)},psd3.Pie.prototype.getDepth=function(t){for(var e=t[0],n=1;null!==e&&void 0!==e&&void 0!==e[this.config.inner]&&e[this.config.inner].length>0;)e=e[this.config.inner][0],n++;return n},psd3.Pie.prototype.setDataSet=function(t,e,n,i){if(null===t||void 0===t)return i;if(e===n){for(var a=0;a<t.length;a++)i.push(t[a]);return i}for(var o=0;o<t.length;o++)i=this.setDataSet(t[o][this.config.inner],e,n+1,i);return i},psd3.Pie.prototype.drawPie=function(t){var e=this,n=[],i=d3.scale.category20(),a=e.config.containerId+"_tooltip",o=d3.select("#"+e.config.containerId).append("svg").attr("id",e.config.containerId+"_svg").attr("width",e.config.width).attr("height",e.config.height),r=d3.select("#"+e.config.containerId).append("div").attr("id",a).attr("class","psd3Hidden psd3Tooltip");r.append("p").append("span").attr("id","value").text("100%");var s=d3.layout.pie();s.value(function(t){return t[e.config.value]}),s.sort(null);for(var d=e.config.width/2,c=this.getDepth(t),p=0,l=function(t){e.reDrawPie(t,I)},g=function(t,e){return i(e+p)},h=function(t){d3.select("#"+a).style("left",d3.event.clientX+"px").style("top",d3.event.clientY+"px").select("#value").html(e.config.tooltip(t.data,e.config.label)),d3.select("#"+a).classed("psd3Hidden",!1)},f=function(){d3.select("#"+a).classed("psd3Hidden",!0)},u=function(t){t.arc=x,t.length=I.length,t.parentDs=I},v=function(t){var e={startAngle:0,endAngle:0},n=d3.interpolate(e,t);return function(e){return t.arc(n(e))}},y=c;y>=1;y--){var P=e.config.donutRadius+(d-e.config.donutRadius)/c*y,m=P-d/c;1==y&&(m=e.config.donutRadius);var x=d3.svg.arc().innerRadius(m).outerRadius(P),w="arc"+y,D=[],I=this.setDataSet(t,y,1,D),b=o.selectAll("g."+w).data(s(I)).enter().append("g").attr("class","arc "+w).attr("transform","translate("+d+","+d+")").on("dblclick",l);paths=b.append("path").attr("fill",g),paths.on("mouseover",h),paths.on("mouseout",f),paths.each(u),paths.transition().duration(e.config.transitionDuration).ease("linear").attrTween("d",v),p+=I.length,n[y]=b}for(var H=function(t){return"translate("+t.arc.centroid(t)+")"},S=function(t){return e.config.label(t.data)},R=function(t){return t.data[e.config.value]},k=1;c>=k;k++)n[k].append("text").transition().ease("linear").duration(e.config.transitionDuration).delay(e.config.transitionDuration).attr("transform",H).attr("text-anchor","middle").text(S).attr("title",R)},psd3.Pie.prototype.reDrawPie=function(t,e){var n=[];d3.select("#"+this.config.containerId+"_svg").remove(),d3.select("#"+this.config.containerId+"_tooltip").remove(),1==t.length?n=this.zoomStack.pop():(n.push(t.data),this.zoomStack.push(e)),this.drawPie(n)};